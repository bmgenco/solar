---
title: "Solar & Energy Efficiency Decision Analysis"
subtitle: "2265 Ridgedale Road, Decatur GA"
author: "Energy Analysis Framework"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

# Load required libraries
library(tidyverse)
library(lubridate)
library(plotly)
library(DT)
library(kableExtra)
```

# 1. Data Input - Multiple Energy Data Sources

## 1a. Emporia Circuit-Level Data

```{r emporia_data_import}
# Function to load Emporia circuit-level energy monitoring data
load_emporia_data <- function(file_path, resolution = "daily") {
  
  # Column name mapping to clean up long Emporia names
  emporia_data <- read.csv(file_path, stringsAsFactors = FALSE)
  
  # Parse datetime
  emporia_data$datetime <- as.POSIXct(emporia_data[,1], 
                                      format = "%Y-%m-%d %H:%M:%S", 
                                      tz = "America/New_York")
  
  # Calculate total house consumption (Mains A + Mains B)
  mains_a_col <- grep("Mains_A", names(emporia_data), value = TRUE)[1]
  mains_b_col <- grep("Mains_B", names(emporia_data), value = TRUE)[1]
  
  emporia_data$total_house_kwh <- emporia_data[[mains_a_col]] + emporia_data[[mains_b_col]]
  
  # Clean up circuit names for easier analysis
  names(emporia_data) <- gsub("Ridgedale.electrical.meter.", "", names(emporia_data))
  names(emporia_data) <- gsub("\\.\\.kWhs\\.", "_kwh", names(emporia_data))
  names(emporia_data) <- gsub("\\.\\.kWatts\\.", "_kw", names(emporia_data))
  
  # Extract key circuits for analysis
  emporia_data <- emporia_data %>%
    rename_with(~ str_replace_all(.x, "\\.", "_")) %>%
    filter(!is.na(datetime), total_house_kwh > 0) %>%
    arrange(datetime)
  
  cat("=== EMPORIA DATA SUMMARY ===\n")
  cat("Date range:", min(emporia_data$datetime), "to", max(emporia_data$datetime), "\n")
  cat("Total records:", nrow(emporia_data), "\n")
  cat("Resolution:", resolution, "\n")
  cat("Total consumption:", round(sum(emporia_data$total_house_kwh, na.rm = TRUE), 1), "kWh\n")
  
  return(emporia_data)
}

# Load Emporia data
# emporia_data <- load_emporia_data("path/to/emporia/file.csv", "daily")
```

## 1b. Ecobee Thermostat Data

```{r ecobee_data_import}
# Function to load and combine multiple Ecobee monthly CSV files
load_ecobee_data <- function(folder_path = "ecobee_data/") {
  
  # Get all CSV files in folder matching ecobee pattern
  csv_files <- list.files(folder_path, pattern = "report.*\\.csv$", full.names = TRUE)
  
  if(length(csv_files) == 0) {
    cat("No ecobee CSV files found in", folder_path, "\n")
    return(NULL)
  }
  
  cat("Found", length(csv_files), "ecobee files to process\n")
  
  # Read and combine all files
  ecobee_combined <- map_dfr(csv_files, function(file) {
    
    cat("Processing:", basename(file), "\n")
    
    # Read raw file to handle header metadata
    raw_lines <- readLines(file)
    
    # Find where actual CSV data starts (skip header metadata)
    csv_start <- which(str_detect(raw_lines, "^Date,Time,"))[1]
    
    if(is.na(csv_start)) {
      warning("Could not find CSV header in file: ", file)
      return(NULL)
    }
    
    # Extract metadata from header lines
    thermostat_id <- str_extract(raw_lines[1], "\\d+")
    start_date <- str_extract(raw_lines[3], "\\d{4}-\\d{2}-\\d{2}")
    end_date <- str_extract(raw_lines[4], "\\d{4}-\\d{2}-\\d{2}")
    
    # Write CSV data to temporary file (skip metadata lines)
    temp_file <- tempfile()
    writeLines(raw_lines[csv_start:length(raw_lines)], temp_file)
    
    # Read actual CSV data
    data <- read.csv(temp_file, stringsAsFactors = FALSE)
    unlink(temp_file)
    
    # Add metadata columns
    data$thermostat_id <- thermostat_id
    data$file_start_date <- start_date
    data$file_end_date <- end_date
    data$source_file <- basename(file)
    
    return(data)
  })
  
  if(is.null(ecobee_combined) || nrow(ecobee_combined) == 0) {
    warning("No data successfully loaded from ecobee files")
    return(NULL)
  }
  
  # Create proper datetime column
  ecobee_combined$datetime <- as.POSIXct(
    paste(ecobee_combined$Date, ecobee_combined$Time), 
    format = "%Y-%m-%d %H:%M:%S",
    tz = "America/New_York"
  )
  
  # Clean and standardize column names
  ecobee_combined <- ecobee_combined %>%
    rename_with(~ str_replace_all(.x, "\\.", "_")) %>%
    rename_with(~ str_replace_all(.x, "[()%]", "")) %>%
    rename_with(~ tolower(.x))
  
  # Create standardized column names for key metrics
  if("cool_set_temp_f" %in% names(ecobee_combined)) {
    ecobee_combined <- ecobee_combined %>%
      rename(
        cool_setpoint = cool_set_temp_f,
        heat_setpoint = heat_set_temp_f,
        current_temp = current_temp_f,
        current_humidity = current_humidity_rh,
        outdoor_temp = outdoor_temp_f,
        cool_runtime_sec = cool_stage_1_sec,
        heat_runtime_sec = heat_stage_1_sec,
        fan_runtime_sec = fan_sec
      )
  }
  
  # Sort by datetime and calculate derived metrics
  ecobee_combined <- ecobee_combined %>%
    arrange(datetime) %>%
    filter(!is.na(datetime)) %>%
    mutate(
      # Convert runtime seconds to minutes
      cool_runtime_min = cool_runtime_sec / 60,
      heat_runtime_min = heat_runtime_sec / 60,
      fan_runtime_min = fan_runtime_sec / 60,
      
      # Calculate total HVAC runtime
      total_hvac_runtime_min = cool_runtime_min + heat_runtime_min,
      
      # Date components for aggregation
      date = as.Date(datetime),
      hour = hour(datetime),
      month = month(datetime),
      year = year(datetime)
    )
  
  # Data quality summary
  cat("\n=== ECOBEE DATA SUMMARY ===\n")
  cat("Date range:", min(ecobee_combined$datetime), "to", max(ecobee_combined$datetime), "\n")
  cat("Total records:", nrow(ecobee_combined), "\n")
  cat("Data frequency: 5-minute intervals\n")
  cat("Total cooling runtime:", round(sum(ecobee_combined$cool_runtime_min, na.rm = TRUE) / 60, 1), "hours\n")
  cat("Total heating runtime:", round(sum(ecobee_combined$heat_runtime_min, na.rm = TRUE) / 60, 1), "hours\n")
  
  return(ecobee_combined)
}

# Load Ecobee data
# ecobee_data <- load_ecobee_data("path/to/ecobee/files/")
```

## 1c. Georgia Power Usage and Cost Data

```{r ga_power_data_import}
# Function to load and combine Georgia Power Excel files (energy + cost)
load_ga_power_data <- function(energy_file_path, cost_file_path, data_type = "hourly") {
  
  # Function to read and clean individual GA Power file
  read_ga_power_file <- function(file_path, value_col_name) {
    # Read Excel file, skipping header rows
    raw_data <- read_excel(file_path, 
                          sheet = 1,
                          skip = 2,  # Skip disclaimer and account number rows
                          col_names = TRUE)
    
    # Clean column names
    names(raw_data) <- c("hour", "value", "temp")
    
    # Parse and clean data
    clean_data <- raw_data %>%
      mutate(
        # Convert hour to proper datetime
        datetime = if_else(
          is.character(hour),
          as.POSIXct(hour, format = "%Y-%m-%d %H:%M", tz = "America/New_York"),
          as.POSIXct(as.numeric(hour) * 86400, 
                     origin = "1899-12-30", tz = "America/New_York")
        ),
        
        # Clean value data (remove any non-numeric characters)
        !!value_col_name := as.numeric(str_replace_all(as.character(value), "[^0-9.-]", "")),
        
        # Clean temperature data (keep only one temp column)
        outdoor_temp = as.numeric(temp)
      ) %>%
      
      # Select only needed columns
      select(datetime, !!value_col_name, outdoor_temp) %>%
      
      # Remove rows with missing datetime
      filter(!is.na(datetime)) %>%
      arrange(datetime)
    
    return(clean_data)
  }
  
  cat("Loading Georgia Power data files...\n")
  
  # Load energy data (kWh)
  cat("Processing energy file:", basename(energy_file_path), "\n")
  energy_data <- read_ga_power_file(energy_file_path, "kwh_hourly")
  
  # Load cost data ($)
  cat("Processing cost file:", basename(cost_file_path), "\n")
  cost_data <- read_ga_power_file(cost_file_path, "cost_hourly")
  
  # Join the datasets by datetime using inner_join to ensure matching records
  ga_power_data <- energy_data %>%
    inner_join(cost_data %>% select(datetime, cost_hourly), 
               by = "datetime", 
               suffix = c("_energy", "_cost")) %>%
    
    # Add derived columns
    mutate(
      # Extract date components for aggregation
      date = as.Date(datetime),
      hour_of_day = hour(datetime),
      month = month(datetime),
      year = year(datetime),
      week_day = wday(datetime, label = TRUE),
      
      # Calculate effective rate ($/kWh) - handle division by zero
      rate_per_kwh = if_else(kwh_hourly > 0, cost_hourly / kwh_hourly, NA_real_),
      
      # Calculate time-of-use periods (adjust based on GA Power rate schedule)
      time_period = case_when(
        hour_of_day >= 14 & hour_of_day < 19 & 
          week_day %in% c("Mon", "Tue", "Wed", "Thu", "Fri") ~ "peak",        # 2-7 PM weekdays
        hour_of_day >= 6 & hour_of_day < 14 & 
          week_day %in% c("Mon", "Tue", "Wed", "Thu", "Fri") ~ "shoulder",    # 6 AM - 2 PM weekdays  
        TRUE ~ "off_peak"                                                     # Nights and weekends
      ),
      
      # Season for rate analysis
      season = case_when(
        month %in% c(6, 7, 8, 9) ~ "summer",
        month %in% c(12, 1, 2) ~ "winter", 
        TRUE ~ "spring_fall"
      )
    ) %>%
    arrange(datetime)
  
  # Data validation and quality checks
  cat("\n=== GEORGIA POWER COMBINED DATA SUMMARY ===\n")
  cat("Date range:", min(ga_power_data$datetime), "to", max(ga_power_data$datetime), "\n")
  cat("Total records:", nrow(ga_power_data), "\n")
  cat("Total kWh in period:", round(sum(ga_power_data$kwh_hourly, na.rm = TRUE), 1), "\n")
  cat("Total cost in period: $", round(sum(ga_power_data$cost_hourly, na.rm = TRUE), 2), "\n")
  
  # Rate analysis
  rate_stats <- ga_power_data %>%
    filter(!is.na(rate_per_kwh), is.finite(rate_per_kwh)) %>%
    summarise(
      avg_rate = mean(rate_per_kwh),
      median_rate = median(rate_per_kwh)
    )
  cat("Average rate: $", round(rate_stats$avg_rate, 4), "/kWh\n")
  
  return(ga_power_data)
}

# Load GA Power data
# ga_power_data <- load_ga_power_data("ENERGY_GPC_Usage_file.xlsx", "COST_GPC_Usage_file.xlsx")
```

## 1d. Data Quality Validation - Emporia vs Georgia Power

```{r emporia_ga_power_comparison}
# Function to compare Emporia vs Georgia Power energy data
compare_emporia_ga_power <- function(emporia_data, ga_power_data, 
                                   comparison_period = "daily") {
  
  cat("=== EMPORIA vs GEORGIA POWER COMPARISON ===\n")
  
  # Prepare Emporia data for comparison
  if(comparison_period == "daily") {
    emporia_agg <- emporia_data %>%
      mutate(date = as.Date(datetime)) %>%
      group_by(date) %>%
      summarise(
        emporia_total_kwh = sum(total_house_kwh, na.rm = TRUE),
        emporia_records = n(),
        .groups = 'drop'
      ) %>%
      filter(emporia_total_kwh > 0)  # Remove days with no data
    
    # Prepare GA Power data  
    ga_power_agg <- ga_power_data %>%
      group_by(date) %>%
      summarise(
        ga_power_total_kwh = sum(kwh_hourly, na.rm = TRUE),
        ga_power_records = n(),
        daily_cost = sum(cost_hourly, na.rm = TRUE),
        avg_temp = mean(outdoor_temp, na.rm = TRUE),
        .groups = 'drop'
      ) %>%
      filter(ga_power_total_kwh > 0)  # Remove days with no data
  }
  
  # Join the datasets
  comparison_data <- emporia_agg %>%
    inner_join(ga_power_agg, by = "date") %>%
    mutate(
      # Calculate differences
      kwh_difference = emporia_total_kwh - ga_power_total_kwh,
      kwh_difference_pct = (kwh_difference / ga_power_total_kwh) * 100,
      
      # Absolute difference for magnitude analysis
      abs_difference = abs(kwh_difference),
      abs_difference_pct = abs(kwh_difference_pct)
    ) %>%
    filter(
      # Remove periods with very low usage (measurement noise)
      ga_power_total_kwh > 0.1,
      emporia_total_kwh > 0.1
    )
  
  # Calculate summary metrics
  summary_stats <- comparison_data %>%
    summarise(
      emporia_total = sum(emporia_total_kwh),
      ga_power_total = sum(ga_power_total_kwh),
      total_difference = sum(kwh_difference),
      total_difference_pct = (total_difference / ga_power_total) * 100,
      correlation = cor(emporia_total_kwh, ga_power_total_kwh),
      mean_abs_difference_pct = mean(abs_difference_pct),
      large_discrepancies = sum(abs_difference_pct > 10)
    )
  
  # Print summary
  cat("Overlapping periods:", nrow(comparison_data), "\n")
  cat("Emporia total:", round(summary_stats$emporia_total, 1), "kWh\n")
  cat("GA Power total:", round(summary_stats$ga_power_total, 1), "kWh\n") 
  cat("Percentage difference:", round(summary_stats$total_difference_pct, 2), "%\n")
  cat("Correlation coefficient:", round(summary_stats$correlation, 3), "\n")
  cat("Mean absolute % difference:", round(summary_stats$mean_abs_difference_pct, 1), "%\n")
  cat("Periods with >10% discrepancy:", summary_stats$large_discrepancies, "\n")
  
  # Create scatter plot
  scatter_plot <- ggplot(comparison_data, 
                        aes(x = ga_power_total_kwh, y = emporia_total_kwh)) +
    geom_point(alpha = 0.6, color = "blue") +
    geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
    geom_smooth(method = "lm", se = TRUE, color = "green") +
    labs(
      title = "Emporia vs GA Power - Daily Comparison",
      x = "GA Power kWh",
      y = "Emporia kWh",
      caption = paste("Correlation:", round(summary_stats$correlation, 3),
                     "| Total difference:", round(summary_stats$total_difference_pct, 1), "%")
    ) +
    theme_minimal()
  
  # Return results
  results <- list(
    comparison_data = comparison_data,
    summary_stats = summary_stats,
    scatter_plot = scatter_plot
  )
  
  return(results)
}

# Run data validation
# comparison_results <- compare_emporia_ga_power(emporia_data, ga_power_data, "daily")
# print(comparison_results$scatter_plot)
```

# 2. House Parameters - Current Status

```{r house_parameters}
# Property characteristics (from inspection documents)
house_params <- list(
  # Basic property data
  property_address = "2265 Ridgedale Road Northeast, Atlanta, GA 30317",
  lot_size_acres = 0.167,
  house_sqft = 1067,
  house_age = 2024 - 1934,  # Built in 1934
  primary_roof_orientation = "west",
  
  # Current energy profile
  annual_kwh_baseline = 6540,
  daily_avg_kwh = 17.82,
  ac_load_pct = 29.8,
  heating_load_pct = 15.0,
  other_load_pct = 55.2,
  
  # Electrical system
  current_panel_amps = 100,
  panel_upgrade_required = TRUE,
  target_panel_amps = 200,
  panel_upgrade_completed = FALSE,
  
  # HVAC system ages (for replacement planning)
  ac_install_year = 2010,
  heating_install_year = 2009,
  water_heater_install_year = 2018,
  
  # Current status of improvements
  roof_west_new = TRUE,
  roof_west_solar_ready = TRUE,
  crawlspace_encapsulated = TRUE,
  trees_trimmed_west_roof = TRUE,
  hvac_filter_seal_repaired = TRUE
)

# Display current status
cat("=== CURRENT HOUSE STATUS ===\n")
cat("Property:", house_params$property_address, "\n")
cat("House age:", house_params$house_age, "years\n")
cat("Annual consumption:", house_params$annual_kwh_baseline, "kWh\n")
cat("Solar-ready roof:", house_params$roof_west_solar_ready, "\n")
cat("200A panel upgrade needed:", house_params$panel_upgrade_required, "\n")
```

## 2b. Efficiency Upgrade Parameters

```{r efficiency_upgrades}
# Define efficiency upgrade options with costs and savings
efficiency_upgrades <- data.frame(
  upgrade_name = c(
    "200A_panel_upgrade",
    "ac_drain_extension", 
    "refrigerant_insulation",
    "door_weatherstripping",
    "attic_insulation_R60"
  ),
  
  # Estimated costs
  cost_low = c(3950, 200, 300, 150, 2500),
  cost_high = c(7800, 400, 500, 300, 4000),
  cost_default = c(5875, 300, 400, 225, 3250),
  
  # Estimated annual kWh savings
  kwh_savings_low = c(0, 50, 100, 75, 300),
  kwh_savings_high = c(0, 100, 200, 150, 600),
  kwh_savings_default = c(0, 75, 150, 112, 450),
  
  # Required for solar installation
  required_for_solar = c(TRUE, FALSE, FALSE, FALSE, FALSE),
  
  # Current status
  completed = c(FALSE, FALSE, FALSE, FALSE, FALSE),
  
  # Priority ranking (1 = highest)
  priority = c(1, 4, 3, 5, 2)
)

# Display efficiency upgrade options
kable(efficiency_upgrades, 
      caption = "Available Efficiency Upgrades") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## 2c. Calculate Current vs. Improved Efficiency

```{r calculate_efficiency}
# Function to calculate efficiency scenarios
calculate_efficiency_scenarios <- function(base_kwh, upgrades_df) {
  
  scenarios <- list()
  
  # Current baseline
  scenarios$current <- list(
    name = "Current Status",
    annual_kwh = base_kwh,
    completed_upgrades = sum(upgrades_df$completed),
    total_cost = 0,
    annual_savings_kwh = 0
  )
  
  # Individual upgrade scenarios
  for(i in 1:nrow(upgrades_df)) {
    upgrade <- upgrades_df[i,]
    scenarios[[paste0("upgrade_", i)]] <- list(
      name = upgrade$upgrade_name,
      annual_kwh = base_kwh - upgrade$kwh_savings_default,
      annual_savings_kwh = upgrade$kwh_savings_default,
      cost = upgrade$cost_default,
      required_for_solar = upgrade$required_for_solar
    )
  }
  
  # All efficiency upgrades scenario
  total_savings <- sum(upgrades_df$kwh_savings_default)
  total_cost <- sum(upgrades_df$cost_default)
  
  scenarios$all_efficiency <- list(
    name = "All Efficiency Upgrades",
    annual_kwh = base_kwh - total_savings,
    annual_savings_kwh = total_savings,
    cost = total_cost,
    efficiency_improvement_pct = round(total_savings / base_kwh * 100, 1)
  )
  
  return(scenarios)
}

# Calculate scenarios
efficiency_scenarios <- calculate_efficiency_scenarios(
  house_params$annual_kwh_baseline, 
  efficiency_upgrades
)

# Display scenarios
cat("=== EFFICIENCY SCENARIOS ===\n")
for(scenario_name in names(efficiency_scenarios)) {
  scenario <- efficiency_scenarios[[scenario_name]]
  cat("\n", scenario$name, ":\n")
  cat("  Annual kWh:", scenario$annual_kwh, "\n")
  if(!is.null(scenario$annual_savings_kwh)) {
    cat("  Annual savings:", scenario$annual_savings_kwh, "kWh\n")
  }
  if(!is.null(scenario$cost)) {
    cat("  Cost: $", format(scenario$cost, big.mark = ","), "\n")
  }
}
```

# 3. Economic Data (Online Sources)

```{r economic_parameters}
# Economic parameters - default values (will be updated from online sources)
economic_params <- list(
  # Utility rates
  current_electricity_rate = 0.12,  # $/kWh default
  rate_escalation_annual = 0.03,    # 3% annual increase
  
  # Solar economics
  solar_cost_per_watt = 4.15,       # $/W after tax credit
  solar_degradation_annual = 0.005, # 0.5% annual degradation
  federal_tax_credit = 0.30,        # 30% through 2025
  
  # Financial assumptions
  discount_rate = 0.04,             # 4% for NPV calculations
  analysis_period_years = 25,       # Standard solar analysis period
  
  # Home value
  home_value_current = 350000,      # Estimated current value
  solar_home_value_premium = 0.04   # 4% premium for solar homes
)

# Function to fetch current electricity rates (placeholder for online data)
fetch_electricity_rates <- function(utility = "Georgia_Power", zip = "30317") {
  # Placeholder - will implement API calls in separate chat
  cat("Online rate fetching not implemented yet.\n")
  cat("Using default rate:", economic_params$current_electricity_rate, "$/kWh\n")
  return(economic_params$current_electricity_rate)
}

# Update rates (placeholder)
current_rate <- fetch_electricity_rates()

cat("=== ECONOMIC ASSUMPTIONS ===\n")
cat("Current electricity rate: $", economic_params$current_electricity_rate, "/kWh\n")
cat("Federal tax credit:", economic_params$federal_tax_credit * 100, "%\n")
cat("Analysis period:", economic_params$analysis_period_years, "years\n")
```

# 4. Emissions Factors (Default with User Override)

```{r emissions_factors}
# Emissions factors - user configurable
emissions_params <- list(
  # Grid electricity emissions (lbs CO2/kWh)
  grid_emissions_factor = 0.99,     # GA Power comprehensive factor
  grid_emissions_decline_rate = 0.02, # 2% annual improvement
  
  # Natural gas emissions (lbs CO2/therm)
  gas_combustion_factor = 11.7,     # Direct combustion
  gas_fugitive_multiplier = 1.25,   # 25% additional from methane leaks
  gas_total_factor = 11.7 * 1.25,   # Total factor
  
  # Solar emissions (manufacturing/installation)
  solar_lifecycle_emissions = 0.04, # lbs CO2/kWh over lifetime
  
  # Appliance-specific factors
  water_heater_gas_therms_annual = 200,  # Typical gas water heater
  hvac_gas_therms_annual = 600,          # Heating portion
  
  # Social cost of carbon ($/ton CO2)
  social_cost_carbon = 51  # EPA 2024 estimate
)

# Function to calculate emissions scenarios
calculate_emissions_scenarios <- function(kwh_consumption, params) {
  
  # Convert lbs to tons (2000 lbs = 1 ton)
  lbs_to_tons <- function(lbs) lbs / 2000
  
  scenarios <- list()
  
  # Current emissions
  grid_emissions_lbs <- kwh_consumption * params$grid_emissions_factor
  gas_water_emissions_lbs <- params$water_heater_gas_therms_annual * params$gas_total_factor
  gas_heating_emissions_lbs <- params$hvac_gas_therms_annual * params$gas_total_factor
  
  total_emissions_tons <- lbs_to_tons(grid_emissions_lbs + gas_water_emissions_lbs + gas_heating_emissions_lbs)
  
  scenarios$current <- list(
    name = "Current Emissions",
    grid_emissions_tons = lbs_to_tons(grid_emissions_lbs),
    gas_emissions_tons = lbs_to_tons(gas_water_emissions_lbs + gas_heating_emissions_lbs),
    total_emissions_tons = total_emissions_tons,
    social_cost_annual = total_emissions_tons * params$social_cost_carbon
  )
  
  return(scenarios)
}

# Calculate current emissions
emissions_scenarios <- calculate_emissions_scenarios(
  house_params$annual_kwh_baseline,
  emissions_params
)

cat("=== EMISSIONS ANALYSIS ===\n")
cat("Current annual emissions:", round(emissions_scenarios$current$total_emissions_tons, 2), "tons CO2\n")
cat("Social cost of current emissions: $", round(emissions_scenarios$current$social_cost_annual, 0), "/year\n")

# Display user-configurable emissions factors
emissions_table <- data.frame(
  Parameter = c("Grid Emissions Factor", "Natural Gas Factor", "Social Cost of Carbon"),
  Current_Value = c(
    paste(emissions_params$grid_emissions_factor, "lbs CO2/kWh"),
    paste(round(emissions_params$gas_total_factor, 1), "lbs CO2/therm"),
    paste("$", emissions_params$social_cost_carbon, "/ton CO2")
  ),
  Description = c(
    "Including fugitive emissions",
    "Including methane leaks (25% adder)", 
    "EPA 2024 social cost estimate"
  )
)

kable(emissions_table, caption = "User-Configurable Emissions Factors") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# 5. Preliminary Graphing

```{r preliminary_graphs}
# Create summary visualization of current status vs. potential improvements

# Prepare data for visualization
consumption_comparison <- data.frame(
  Scenario = c("Current", "With Efficiency Upgrades", "Potential with Solar"),
  Annual_kWh = c(
    house_params$annual_kwh_baseline,
    efficiency_scenarios$all_efficiency$annual_kwh,
    0  # Will calculate solar offset
  ),
  Annual_Cost = c(
    house_params$annual_kwh_baseline * economic_params$current_electricity_rate,
    efficiency_scenarios$all_efficiency$annual_kwh * economic_params$current_electricity_rate,
    NA  # TBD with solar analysis
  ),
  CO2_Tons = c(
    emissions_scenarios$current$total_emissions_tons,
    emissions_scenarios$current$total_emissions_tons * 0.85,  # Estimated 15% reduction
    NA  # TBD with solar analysis
  )
)

# Energy consumption comparison
p1 <- ggplot(consumption_comparison[1:2,], aes(x = Scenario, y = Annual_kWh)) +
  geom_col(fill = c("red", "orange")) +
  geom_text(aes(label = paste(Annual_kWh, "kWh")), vjust = -0.5) +
  labs(title = "Annual Energy Consumption Scenarios",
       y = "Annual kWh",
       subtitle = paste("Potential savings:", 
                       house_params$annual_kwh_baseline - efficiency_scenarios$all_efficiency$annual_kwh, "kWh")) +
  theme_minimal()

# Cost comparison
p2 <- ggplot(consumption_comparison[1:2,], aes(x = Scenario, y = Annual_Cost)) +
  geom_col(fill = c("red", "orange")) +
  geom_text(aes(label = paste("$", round(Annual_Cost, 0))), vjust = -0.5) +
  labs(title = "Annual Electricity Cost Scenarios",
       y = "Annual Cost ($)") +
  theme_minimal()

# Display plots
print(p1)
print(p2)

# Summary metrics table
summary_metrics <- data.frame(
  Metric = c(
    "Current Annual Consumption",
    "Efficiency Upgrade Potential", 
    "Total Upgrade Investment",
    "Current Annual Emissions",
    "200A Panel Upgrade Required"
  ),
  Value = c(
    paste(house_params$annual_kwh_baseline, "kWh"),
    paste(efficiency_scenarios$all_efficiency$annual_savings_kwh, "kWh savings"),
    paste("$", format(efficiency_scenarios$all_efficiency$cost, big.mark = ",")),
    paste(round(emissions_scenarios$current$total_emissions_tons, 2), "tons CO2"),
    ifelse(house_params$panel_upgrade_required, "YES (Required for Solar)", "No")
  )
)

kable(summary_metrics, caption = "Key Decision Metrics") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# 6. Sensitivity Analysis Framework

```{r sensitivity_setup}
# Set up sensitivity analysis parameters
sensitivity_params <- list(
  # Variables to test
  variables = c(
    "electricity_rate",
    "solar_cost_per_watt", 
    "move_out_timeline",
    "efficiency_savings",
    "emissions_factor"
  ),
  
  # Variation ranges (low, baseline, high)
  electricity_rate_range = c(0.09, 0.12, 0.18),
  solar_cost_range = c(3.50, 4.15, 5.00),
  timeline_range = c(3, 10, 20),  # years
  efficiency_range = c(0.10, 0.15, 0.25),  # % savings
  emissions_range = c(0.45, 0.99, 1.20)  # lbs CO2/kWh
)

# Function to run sensitivity analysis (framework)
run_sensitivity_analysis <- function(base_params, sensitivity_ranges) {
  
  cat("=== SENSITIVITY ANALYSIS FRAMEWORK ===\n")
  cat("Variables to analyze:\n")
  for(var in sensitivity_params$variables) {
    cat("  -", var, "\n")
  }
  
  cat("\nSensitivity ranges defined. Full analysis will calculate:\n")
  cat("  - ROI impact of each variable\n")
  cat("  - Break-even points\n") 
  cat("  - Risk/uncertainty bounds\n")
  cat("  - Optimal decision thresholds\n")
  
  # Placeholder for full sensitivity analysis
  # Will implement tornado diagrams, scenario matrices, etc.
  
  return("Sensitivity framework ready")
}

# Initialize sensitivity analysis
sensitivity_result <- run_sensitivity_analysis(economic_params, sensitivity_params)
```

# Next Steps and Script Usage

```{r next_steps}
cat("=== R SCRIPT FRAMEWORK COMPLETE ===\n\n")

cat("NEXT STEPS:\n")
cat("1. Replace sample energy data with your actual CSV file\n")
cat("2. Update house parameters as you complete improvements\n") 
cat("3. Implement online data fetching for current rates/costs\n")
cat("4. Add solar system sizing and production calculations\n")
cat("5. Build comprehensive financial modeling (NPV, ROI, payback)\n")
cat("6. Complete sensitivity analysis with visualizations\n")
cat("7. Add decision optimization algorithms\n\n")

cat("TO USE THIS SCRIPT:\n")
cat("1. Save your energy bill data as 'energy_data.csv' with columns: date, kwh, cost\n")
cat("2. Update the efficiency_upgrades table as you complete improvements\n")
cat("3. Modify economic_params and emissions_params as needed\n")
cat("4. Re-run the entire script to see updated analysis\n\n")

cat("KEY VARIABLES YOU CAN MODIFY:\n")
cat("- house_params: Update completion status of improvements\n")
cat("- efficiency_upgrades: Add/modify upgrade options and costs\n") 
cat("- economic_params: Update rates, solar costs, financial assumptions\n")
cat("- emissions_params: Adjust emissions factors and social costs\n")
cat("- sensitivity_params: Change variables and ranges for analysis\n")
```