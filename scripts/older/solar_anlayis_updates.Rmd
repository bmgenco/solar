---
title: "solar chunks"
output: html_document
date: "2025-09-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r ecobee_data_import}
# Function to load and combine multiple Ecobee monthly CSV files
load_ecobee_data <- function(folder_path = "ecobee_data/") {
  
  # Load required libraries
  library(tidyverse)
  library(stringr)
  
  # Get all CSV files in folder matching ecobee pattern
  csv_files <- list.files(folder_path, pattern = "report.*\\.csv$", full.names = TRUE)
  
  if(length(csv_files) == 0) {
    cat("No ecobee CSV files found in", folder_path, "\n")
    return(NULL)
  }
  
  cat("Found", length(csv_files), "ecobee files to process\n")
  
  # Read and combine all files
  ecobee_combined <- map_dfr(csv_files, function(file) {
    
    cat("Processing:", basename(file), "\n")
    
    # Read raw file to handle header metadata
    raw_lines <- readLines(file)
    
    # Find where actual CSV data starts (skip header metadata)
    csv_start <- which(str_detect(raw_lines, "^Date,Time,"))[1]
    
    if(is.na(csv_start)) {
      warning("Could not find CSV header in file: ", file)
      return(NULL)
    }
    
    # Extract metadata from header lines
    thermostat_id <- str_extract(raw_lines[1], "\\d+")
    start_date <- str_extract(raw_lines[3], "\\d{4}-\\d{2}-\\d{2}")
    end_date <- str_extract(raw_lines[4], "\\d{4}-\\d{2}-\\d{2}")
    
    # Write CSV data to temporary file (skip metadata lines)
    temp_file <- tempfile()
    writeLines(raw_lines[csv_start:length(raw_lines)], temp_file)
    
    # Read actual CSV data
    data <- read.csv(temp_file, stringsAsFactors = FALSE)
    unlink(temp_file)
    
    # Add metadata columns
    data$thermostat_id <- thermostat_id
    data$file_start_date <- start_date
    data$file_end_date <- end_date
    data$source_file <- basename(file)
    
    return(data)
  })
  
  if(is.null(ecobee_combined) || nrow(ecobee_combined) == 0) {
    warning("No data successfully loaded from ecobee files")
    return(NULL)
  }
  
  # Create proper datetime column
  ecobee_combined$datetime <- as.POSIXct(
    paste(ecobee_combined$Date, ecobee_combined$Time), 
    format = "%Y-%m-%d %H:%M:%S",
    tz = "America/New_York"
  )
  
  # Clean and standardize column names
  ecobee_combined <- ecobee_combined %>%
    rename_with(~ str_replace_all(.x, "\\.", "_")) %>%
    rename_with(~ str_replace_all(.x, "[()%]", "")) %>%
    rename_with(~ tolower(.x))
  
  # Create standardized column names for key metrics
  if("cool_set_temp_f" %in% names(ecobee_combined)) {
    ecobee_combined <- ecobee_combined %>%
      rename(
        cool_setpoint = cool_set_temp_f,
        heat_setpoint = heat_set_temp_f,
        current_temp = current_temp_f,
        current_humidity = current_humidity_rh,
        outdoor_temp = outdoor_temp_f,
        cool_runtime_sec = cool_stage_1_sec,
        heat_runtime_sec = heat_stage_1_sec,
        fan_runtime_sec = fan_sec
      )
  }
  
  # Sort by datetime
  ecobee_combined <- ecobee_combined %>%
    arrange(datetime) %>%
    filter(!is.na(datetime))
  
  # Calculate derived metrics
  ecobee_combined <- ecobee_combined %>%
    mutate(
      # Convert runtime seconds to minutes
      cool_runtime_min = cool_runtime_sec / 60,
      heat_runtime_min = heat_runtime_sec / 60,
      fan_runtime_min = fan_runtime_sec / 60,
      
      # Calculate total HVAC runtime
      total_hvac_runtime_min = cool_runtime_min + heat_runtime_min,
      
      # Temperature differential from setpoint
      temp_diff_from_cool_setpoint = current_temp - cool_setpoint,
      temp_diff_from_heat_setpoint = current_temp - heat_setpoint,
      
      # Outdoor temperature for weather normalization
      outdoor_temp_c = (outdoor_temp - 32) * 5/9,
      
      # Date components for aggregation
      date = as.Date(datetime),
      hour = hour(datetime),
      month = month(datetime),
      year = year(datetime)
    )
  
  # Data quality summary
  cat("\n=== ECOBEE DATA SUMMARY ===\n")
  cat("Date range:", min(ecobee_combined$datetime), "to", max(ecobee_combined$datetime), "\n")
  cat("Total records:", nrow(ecobee_combined), "\n")
  cat("Unique thermostats:", length(unique(ecobee_combined$thermostat_id)), "\n")
  cat("Data frequency: 5-minute intervals\n")
  cat("Total cooling runtime:", round(sum(ecobee_combined$cool_runtime_min, na.rm = TRUE) / 60, 1), "hours\n")
  cat("Total heating runtime:", round(sum(ecobee_combined$heat_runtime_min, na.rm = TRUE) / 60, 1), "hours\n")
  
  # Check for common data quality issues
  missing_temp <- sum(is.na(ecobee_combined$current_temp))
  if(missing_temp > 0) {
    cat("Warning:", missing_temp, "records with missing temperature data\n")
  }
  
  return(ecobee_combined)
}

# Example usage:
# ecobee_data <- load_ecobee_data("path/to/ecobee/files/")
# View(head(ecobee_data))
```
```{r ga_power_data_import}
# Function to load and combine Georgia Power Excel files (energy + cost)
load_ga_power_data <- function(energy_file_path, cost_file_path, data_type = "hourly") {
  
  # Load required libraries
  library(readxl)
  library(tidyverse)
  library(lubridate)
  
  # Function to read and clean individual GA Power file
  read_ga_power_file <- function(file_path, value_col_name) {
    # Read Excel file, skipping header rows
    raw_data <- read_excel(file_path, 
                          sheet = 1,
                          skip = 2,  # Skip disclaimer and account number rows
                          col_names = TRUE)
    
    # Clean column names
    names(raw_data) <- c("hour", "value", "temp")
    
    # Parse and clean data
    clean_data <- raw_data %>%
      mutate(
        # Convert hour to proper datetime
        datetime = if_else(
          is.character(hour),
          as.POSIXct(hour, format = "%Y-%m-%d %H:%M", tz = "America/New_York"),
          as.POSIXct(as.numeric(hour) * 86400, 
                     origin = "1899-12-30", tz = "America/New_York")
        ),
        
        # Clean value data (remove any non-numeric characters)
        !!value_col_name := as.numeric(str_replace_all(as.character(value), "[^0-9.-]", "")),
        
        # Clean temperature data (keep only one temp column)
        outdoor_temp = as.numeric(temp)
      ) %>%
      
      # Select only needed columns
      select(datetime, !!value_col_name, outdoor_temp) %>%
      
      # Remove rows with missing datetime
      filter(!is.na(datetime)) %>%
      arrange(datetime)
    
    return(clean_data)
  }
  
  cat("Loading Georgia Power data files...\n")
  
  # Load energy data (kWh)
  cat("Processing energy file:", basename(energy_file_path), "\n")
  energy_data <- read_ga_power_file(energy_file_path, "kwh_hourly")
  
  # Load cost data ($)
  cat("Processing cost file:", basename(cost_file_path), "\n")
  cost_data <- read_ga_power_file(cost_file_path, "cost_hourly")
  
  # Join the datasets by datetime using inner_join to ensure matching records
  ga_power_data <- energy_data %>%
    inner_join(cost_data %>% select(datetime, cost_hourly), 
               by = "datetime", 
               suffix = c("_energy", "_cost")) %>%
    
    # Add derived columns
    mutate(
      # Extract date components for aggregation
      date = as.Date(datetime),
      hour_of_day = hour(datetime),
      month = month(datetime),
      year = year(datetime),
      week_day = wday(datetime, label = TRUE),
      
      # Calculate effective rate ($/kWh) - handle division by zero
      rate_per_kwh = if_else(kwh_hourly > 0, cost_hourly / kwh_hourly, NA_real_),
      
      # Calculate time-of-use periods (adjust based on GA Power rate schedule)
      time_period = case_when(
        hour_of_day >= 14 & hour_of_day < 19 & 
          week_day %in% c("Mon", "Tue", "Wed", "Thu", "Fri") ~ "peak",        # 2-7 PM weekdays
        hour_of_day >= 6 & hour_of_day < 14 & 
          week_day %in% c("Mon", "Tue", "Wed", "Thu", "Fri") ~ "shoulder",    # 6 AM - 2 PM weekdays  
        TRUE ~ "off_peak"                                                     # Nights and weekends
      ),
      
      # Season for rate analysis
      season = case_when(
        month %in% c(6, 7, 8, 9) ~ "summer",
        month %in% c(12, 1, 2) ~ "winter", 
        TRUE ~ "spring_fall"
      )
    ) %>%
    arrange(datetime)
  
  # Data validation and quality checks
  cat("\n=== GEORGIA POWER COMBINED DATA SUMMARY ===\n")
  cat("Date range:", min(ga_power_data$datetime), "to", max(ga_power_data$datetime), "\n")
  cat("Total records:", nrow(ga_power_data), "\n")
  cat("Data frequency:", data_type, "\n")
  cat("Records from energy file:", nrow(energy_data), "\n")
  cat("Records from cost file:", nrow(cost_data), "\n")
  cat("Matched records:", nrow(ga_power_data), "\n")
  
  # Usage and cost analysis
  cat("\nUsage Analysis:\n")
  cat("Total kWh in period:", round(sum(ga_power_data$kwh_hourly, na.rm = TRUE), 1), "\n")
  cat("Average hourly kWh:", round(mean(ga_power_data$kwh_hourly, na.rm = TRUE), 3), "\n")
  cat("Total cost in period: $", round(sum(ga_power_data$cost_hourly, na.rm = TRUE), 2), "\n")
  cat("Average hourly cost: $", round(mean(ga_power_data$cost_hourly, na.rm = TRUE), 3), "\n")
  
  # Rate analysis
  cat("Effective rate analysis ($/kWh):\n")
  rate_stats <- ga_power_data %>%
    filter(!is.na(rate_per_kwh), is.finite(rate_per_kwh)) %>%
    summarise(
      min_rate = min(rate_per_kwh),
      max_rate = max(rate_per_kwh),
      avg_rate = mean(rate_per_kwh),
      median_rate = median(rate_per_kwh)
    )
  cat("  Average: $", round(rate_stats$avg_rate, 4), "/kWh\n")
  cat("  Median: $", round(rate_stats$median_rate, 4), "/kWh\n")
  cat("  Range: $", round(rate_stats$min_rate, 4), " - $", round(rate_stats$max_rate, 4), "/kWh\n")
  
  # Time-of-use breakdown
  tou_summary <- ga_power_data %>%
    group_by(time_period) %>%
    summarise(
      hours = n(),
      total_kwh = sum(kwh_hourly, na.rm = TRUE),
      total_cost = sum(cost_hourly, na.rm = TRUE),
      avg_rate = mean(rate_per_kwh, na.rm = TRUE),
      .groups = 'drop'
    ) %>%
    mutate(
      pct_usage = round(total_kwh / sum(total_kwh) * 100, 1),
      pct_cost = round(total_cost / sum(total_cost) * 100, 1)
    )
  
  cat("\nTime-of-Use Analysis:\n")
  print(tou_summary)
  
  # Temperature correlation
  cat("\nTemperature range:", round(min(ga_power_data$outdoor_temp, na.rm = TRUE), 1), 
      "to", round(max(ga_power_data$outdoor_temp, na.rm = TRUE), 1), "°F\n")
  
  # Check for missing data
  missing_kwh <- sum(is.na(ga_power_data$kwh_hourly))
  missing_cost <- sum(is.na(ga_power_data$cost_hourly))
  missing_temp <- sum(is.na(ga_power_data$outdoor_temp))
  
  if(missing_kwh > 0) cat("Warning:", missing_kwh, "records with missing kWh data\n")
  if(missing_cost > 0) cat("Warning:", missing_cost, "records with missing cost data\n")
  if(missing_temp > 0) cat("Warning:", missing_temp, "records with missing temperature data\n")
  
  return(ga_power_data)
}

# Function to aggregate hourly data to daily/monthly for comparison with other sources
aggregate_ga_power_data <- function(ga_power_data, period = "daily") {
  
  if(period == "daily") {
    aggregated <- ga_power_data %>%
      group_by(date) %>%
      summarise(
        daily_cost = sum(cost_hourly, na.rm = TRUE),
        avg_temp = mean(outdoor_temp, na.rm = TRUE),
        min_temp = min(outdoor_temp, na.rm = TRUE),
        max_temp = max(outdoor_temp, na.rm = TRUE),
        hours_data = n(),
        .groups = 'drop'
      )
  } else if(period == "monthly") {
    aggregated <- ga_power_data %>%
      group_by(year, month) %>%
      summarise(
        month_date = as.Date(paste(year, month, "01", sep = "-")),
        monthly_cost = sum(cost_hourly, na.rm = TRUE),
        avg_temp = mean(outdoor_temp, na.rm = TRUE),
        hours_data = n(),
        .groups = 'drop'
      )
  }
  
  return(aggregated)
}

# Example usage:
# ga_power_data <- load_ga_power_data("GPC_Usage_2023090920250906.xlsx")
# daily_summary <- aggregate_ga_power_data(ga_power_data, "daily")
# monthly_summary <- aggregate_ga_power_data(ga_power_data, "monthly")
```

```{r emporia_ga_power_comparison}
# Function to compare Emporia vs Georgia Power energy data
compare_emporia_ga_power <- function(emporia_data, ga_power_data, 
                                   comparison_period = "daily") {
  
  library(tidyverse)
  library(lubridate)
  library(plotly)
  
  cat("=== EMPORIA vs GEORGIA POWER COMPARISON ===\n")
  
  # Prepare Emporia data for comparison
  if(comparison_period == "daily") {
    emporia_agg <- emporia_data %>%
      mutate(date = as.Date(datetime)) %>%
      group_by(date) %>%
      summarise(
        emporia_total_kwh = sum(total_house_kwh, na.rm = TRUE),
        emporia_records = n(),
        .groups = 'drop'
      ) %>%
      filter(emporia_total_kwh > 0)  # Remove days with no data
    
    # Prepare GA Power data  
    ga_power_agg <- ga_power_data %>%
      group_by(date) %>%
      summarise(
        ga_power_total_kwh = sum(kwh_hourly, na.rm = TRUE),
        ga_power_records = n(),
        daily_cost = sum(cost_hourly, na.rm = TRUE),
        avg_temp = mean(outdoor_temp, na.rm = TRUE),
        .groups = 'drop'
      ) %>%
      filter(ga_power_total_kwh > 0)  # Remove days with no data
    
  } else if(comparison_period == "hourly") {
    # For hourly comparison, need to align timestamps
    emporia_agg <- emporia_data %>%
      mutate(
        hour = floor_date(datetime, "hour")
      ) %>%
      group_by(hour) %>%
      summarise(
        emporia_total_kwh = sum(total_house_kwh, na.rm = TRUE),
        emporia_records = n(),
        .groups = 'drop'
      )
    
    ga_power_agg <- ga_power_data %>%
      mutate(hour = datetime) %>%
      select(hour, ga_power_total_kwh = kwh_hourly, 
             hourly_cost = cost_hourly, outdoor_temp)
  }
  
  # Join the datasets
  comparison_data <- emporia_agg %>%
    inner_join(ga_power_agg, by = if(comparison_period == "daily") "date" else "hour") %>%
    mutate(
      # Calculate differences
      kwh_difference = emporia_total_kwh - ga_power_total_kwh,
      kwh_difference_pct = (kwh_difference / ga_power_total_kwh) * 100,
      
      # Absolute difference for magnitude analysis
      abs_difference = abs(kwh_difference),
      abs_difference_pct = abs(kwh_difference_pct)
    ) %>%
    filter(
      # Remove periods with very low usage (measurement noise)
      ga_power_total_kwh > 0.1,
      emporia_total_kwh > 0.1
    )
  
  # Summary statistics
  cat("Comparison Period:", comparison_period, "\n")
  cat("Overlapping periods:", nrow(comparison_data), "\n")
  cat("Date range:", min(comparison_data[[1]]), "to", max(comparison_data[[1]]), "\n\n")
  
  # Calculate summary metrics
  summary_stats <- comparison_data %>%
    summarise(
      emporia_total = sum(emporia_total_kwh),
      ga_power_total = sum(ga_power_total_kwh),
      total_difference = sum(kwh_difference),
      total_difference_pct = (total_difference / ga_power_total) * 100,
      
      mean_difference = mean(kwh_difference),
      median_difference = median(kwh_difference),
      mean_abs_difference = mean(abs_difference),
      mean_abs_difference_pct = mean(abs_difference_pct),
      
      correlation = cor(emporia_total_kwh, ga_power_total_kwh),
      
      # Count significant discrepancies
      large_discrepancies = sum(abs_difference_pct > 10),
      very_large_discrepancies = sum(abs_difference_pct > 25)
    )
  
  # Print summary
  cat("TOTAL CONSUMPTION COMPARISON:\n")
  cat("Emporia total:", round(summary_stats$emporia_total, 1), "kWh\n")
  cat("GA Power total:", round(summary_stats$ga_power_total, 1), "kWh\n") 
  cat("Difference:", round(summary_stats$total_difference, 1), "kWh\n")
  cat("Percentage difference:", round(summary_stats$total_difference_pct, 2), "%\n\n")
  
  cat("STATISTICAL ANALYSIS:\n")
  cat("Correlation coefficient:", round(summary_stats$correlation, 3), "\n")
  cat("Mean daily difference:", round(summary_stats$mean_difference, 2), "kWh\n")
  cat("Mean absolute difference:", round(summary_stats$mean_abs_difference, 2), "kWh\n")
  cat("Mean absolute % difference:", round(summary_stats$mean_abs_difference_pct, 1), "%\n\n")
  
  cat("DATA QUALITY ISSUES:\n")
  cat("Periods with >10% discrepancy:", summary_stats$large_discrepancies, 
      "(", round(summary_stats$large_discrepancies/nrow(comparison_data)*100, 1), "%)\n")
  cat("Periods with >25% discrepancy:", summary_stats$very_large_discrepancies,
      "(", round(summary_stats$very_large_discrepancies/nrow(comparison_data)*100, 1), "%)\n")
  
  # Identify potential causes of discrepancies
  cat("\nPOTENTIA L DISCREPANCY CAUSES:\n")
  
  if(abs(summary_stats$total_difference_pct) > 5) {
    if(summary_stats$total_difference_pct > 5) {
      cat("- Emporia reading higher than GA Power (", 
          round(summary_stats$total_difference_pct, 1), "% more)\n")
      cat("  Possible causes: Line losses, timing differences, Emporia calibration\n")
    } else {
      cat("- GA Power billing higher than Emporia (", 
          round(abs(summary_stats$total_difference_pct), 1), "% more)\n")
      cat("  Possible causes: Missing Emporia circuits, meter tampering, billing errors\n")
    }
  }
  
  if(summary_stats$correlation < 0.95) {
    cat("- Low correlation (", round(summary_stats$correlation, 3), 
        ") suggests systematic measurement differences\n")
  }
  
  if(summary_stats$mean_abs_difference_pct > 15) {
    cat("- High variability (", round(summary_stats$mean_abs_difference_pct, 1),
        "% average difference) indicates data quality issues\n")
  }
  
  # Create visualizations
  cat("\nGenerating comparison plots...\n")
  
  # Scatter plot
  scatter_plot <- ggplot(comparison_data, 
                        aes(x = ga_power_total_kwh, y = emporia_total_kwh)) +
    geom_point(alpha = 0.6, color = "blue") +
    geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
    geom_smooth(method = "lm", se = TRUE, color = "green") +
    labs(
      title = paste("Emporia vs GA Power -", str_to_title(comparison_period), "Comparison"),
      x = "GA Power kWh",
      y = "Emporia kWh",
      caption = paste("Correlation:", round(summary_stats$correlation, 3),
                     "| Total difference:", round(summary_stats$total_difference_pct, 1), "%")
    ) +
    theme_minimal()
  
  # Time series of differences
  time_series_plot <- ggplot(comparison_data, 
                            aes(x = .data[[names(comparison_data)[1]]], 
                                y = kwh_difference_pct)) +
    geom_line(alpha = 0.7) +
    geom_hline(yintercept = 0, color = "red", linetype = "dashed") +
    geom_hline(yintercept = c(-10, 10), color = "orange", linetype = "dotted") +
    labs(
      title = "Percentage Difference Over Time (Emporia - GA Power)",
      x = "Date",
      y = "Difference (%)",
      caption = "Orange lines indicate ±10% difference threshold"
    ) +
    theme_minimal()
  
  # Return results
  results <- list(
    comparison_data = comparison_data,
    summary_stats = summary_stats,
    scatter_plot = scatter_plot,
    time_series_plot = time_series_plot
  )
  
  return(results)
}

# Function to investigate specific high-discrepancy periods
investigate_discrepancies <- function(comparison_results, threshold_pct = 15) {
  
  high_discrepancy <- comparison_results$comparison_data %>%
    filter(abs_difference_pct > threshold_pct) %>%
    arrange(desc(abs_difference_pct))
  
  cat("=== HIGH DISCREPANCY INVESTIGATION ===\n")
  cat("Periods with >", threshold_pct, "% difference:\n\n")
  
  if(nrow(high_discrepancy) > 0) {
    print(high_discrepancy %>%
          select(1, emporia_total_kwh, ga_power_total_kwh, 
                 kwh_difference, kwh_difference_pct) %>%
          head(10))
    
    cat("\nPossible investigation steps:\n")
    cat("1. Check Emporia circuit coverage on high-discrepancy days\n")
    cat("2. Verify GA Power billing meter readings\n")
    cat("3. Look for power outages or unusual events\n")
    cat("4. Check for missing or failed Emporia sensors\n")
    cat("5. Compare with Ecobee HVAC runtime data\n")
  } else {
    cat("No periods exceed", threshold_pct, "% difference threshold.\n")
    cat("Data quality appears good for energy analysis.\n")
  }
  
  return(high_discrepancy)
}

# Example usage:
# comparison_results <- compare_emporia_ga_power(emporia_data, ga_power_data, "daily")
# print(comparison_results$scatter_plot)
# print(comparison_results$time_series_plot)
# high_disc <- investigate_discrepancies(comparison_results, 15)
```