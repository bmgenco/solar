---
title: "Solar & Energy Efficiency Decision Analysis"
subtitle: "2265 Ridgedale Road, Decatur GA"
author: "Energy Analysis Framework"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
f.ipak <- function(pkg){
  # loads packages, quietly, given by a vector of package names e.g., pkg<-c("ggplot", "tidyverse")
  # will install  packages listed , and their dependencies, if needed.
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE, quiet=T, verbose = F)
  sapply(pkg, require, character.only = TRUE, quietly = FALSE, warn.conflicts=F)
}

packages<-c("tidyverse", "lubridate", "Plotly", "DT", "kableExtra")

f.ipak(packages)
```

# 1. Data Input - CSV Energy Consumption

```{r data_input}
# Function to load and clean energy data
load_energy_data <- function(csv_path = "energy_data.csv") {
  if(file.exists(csv_path)) {
    energy_data <- read.csv(csv_path, stringsAsFactors = FALSE)
    
    # Convert date column (adjust column name as needed)
    if("date" %in% names(energy_data)) {
      energy_data$date <- as.Date(energy_data$date)
    }
    
    # Clean and validate data
    energy_data <- energy_data %>%
      filter(!is.na(kwh)) %>%
      arrange(date)
    
    return(energy_data)
  } else {
    # Create sample data structure if file doesn't exist
    cat("CSV file not found. Creating sample data structure.\n")
    sample_data <- data.frame(
      date = seq(as.Date("2023-01-01"), as.Date("2023-12-31"), by = "month"),
      kwh = c(620, 580, 540, 480, 520, 680, 750, 820, 720, 580, 510, 590),
      cost = c(85, 79, 74, 65, 71, 93, 103, 112, 99, 79, 70, 81)
    )
    return(sample_data)
  }
}

# Load the data
energy_data <- load_energy_data()

# Display data summary
cat("Energy Data Summary:\n")
cat("Date range:", min(energy_data$date), "to", max(energy_data$date), "\n")
cat("Total annual kWh:", sum(energy_data$kwh), "\n")
cat("Average monthly kWh:", round(mean(energy_data$kwh), 1), "\n")

# Show first few rows
head(energy_data)
```

# 2. House Parameters - Current Status

```{r house_parameters}
# Property characteristics (from inspection documents)
house_params <- list(
  # Basic property data
  property_address = "2265 Ridgedale Road Northeast, Atlanta, GA 30317",
  lot_size_acres = 0.167,
  house_sqft = 1067,
  house_age = 2024 - 1934,  # Built in 1934
  primary_roof_orientation = "west",
  
  # Current energy profile
  annual_kwh_baseline = 6540,
  daily_avg_kwh = 17.82,
  ac_load_pct = 29.8,
  heating_load_pct = 15.0,
  other_load_pct = 55.2,
  
  # Electrical system
  current_panel_amps = 100,
  panel_upgrade_required = TRUE,
  target_panel_amps = 200,
  panel_upgrade_completed = FALSE,
  
  # HVAC system ages (for replacement planning)
  ac_install_year = 2010,
  heating_install_year = 2009,
  water_heater_install_year = 2018,
  
  # Current status of improvements
  roof_west_new = TRUE,
  roof_west_solar_ready = TRUE,
  crawlspace_encapsulated = TRUE,
  trees_trimmed_west_roof = TRUE,
  hvac_filter_seal_repaired = TRUE
)

# Display current status
cat("=== CURRENT HOUSE STATUS ===\n")
cat("Property:", house_params$property_address, "\n")
cat("House age:", house_params$house_age, "years\n")
cat("Annual consumption:", house_params$annual_kwh_baseline, "kWh\n")
cat("Solar-ready roof:", house_params$roof_west_solar_ready, "\n")
cat("200A panel upgrade needed:", house_params$panel_upgrade_required, "\n")
```

## 2b. Efficiency Upgrade Parameters

```{r efficiency_upgrades}
# Define efficiency upgrade options with costs and savings
efficiency_upgrades <- data.frame(
  upgrade_name = c(
    "200A_panel_upgrade",
    "ac_drain_extension", 
    "refrigerant_insulation",
    "door_weatherstripping",
    "attic_insulation_R60"
  ),
  
  # Estimated costs
  cost_low = c(3950, 200, 300, 150, 2500),
  cost_high = c(7800, 400, 500, 300, 4000),
  cost_default = c(5875, 300, 400, 225, 3250),
  
  # Estimated annual kWh savings
  kwh_savings_low = c(0, 50, 100, 75, 300),
  kwh_savings_high = c(0, 100, 200, 150, 600),
  kwh_savings_default = c(0, 75, 150, 112, 450),
  
  # Required for solar installation
  required_for_solar = c(TRUE, FALSE, FALSE, FALSE, FALSE),
  
  # Current status
  completed = c(FALSE, FALSE, FALSE, FALSE, FALSE),
  
  # Priority ranking (1 = highest)
  priority = c(1, 4, 3, 5, 2)
)

# Display efficiency upgrade options
kable(efficiency_upgrades, 
      caption = "Available Efficiency Upgrades") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

## 2c. Calculate Current vs. Improved Efficiency

```{r calculate_efficiency}
# Function to calculate efficiency scenarios
calculate_efficiency_scenarios <- function(base_kwh, upgrades_df) {
  
  scenarios <- list()
  
  # Current baseline
  scenarios$current <- list(
    name = "Current Status",
    annual_kwh = base_kwh,
    completed_upgrades = sum(upgrades_df$completed),
    total_cost = 0,
    annual_savings_kwh = 0
  )
  
  # Individual upgrade scenarios
  for(i in 1:nrow(upgrades_df)) {
    upgrade <- upgrades_df[i,]
    scenarios[[paste0("upgrade_", i)]] <- list(
      name = upgrade$upgrade_name,
      annual_kwh = base_kwh - upgrade$kwh_savings_default,
      annual_savings_kwh = upgrade$kwh_savings_default,
      cost = upgrade$cost_default,
      required_for_solar = upgrade$required_for_solar
    )
  }
  
  # All efficiency upgrades scenario
  total_savings <- sum(upgrades_df$kwh_savings_default)
  total_cost <- sum(upgrades_df$cost_default)
  
  scenarios$all_efficiency <- list(
    name = "All Efficiency Upgrades",
    annual_kwh = base_kwh - total_savings,
    annual_savings_kwh = total_savings,
    cost = total_cost,
    efficiency_improvement_pct = round(total_savings / base_kwh * 100, 1)
  )
  
  return(scenarios)
}

# Calculate scenarios
efficiency_scenarios <- calculate_efficiency_scenarios(
  house_params$annual_kwh_baseline, 
  efficiency_upgrades
)

# Display scenarios
cat("=== EFFICIENCY SCENARIOS ===\n")
for(scenario_name in names(efficiency_scenarios)) {
  scenario <- efficiency_scenarios[[scenario_name]]
  cat("\n", scenario$name, ":\n")
  cat("  Annual kWh:", scenario$annual_kwh, "\n")
  if(!is.null(scenario$annual_savings_kwh)) {
    cat("  Annual savings:", scenario$annual_savings_kwh, "kWh\n")
  }
  if(!is.null(scenario$cost)) {
    cat("  Cost: $", format(scenario$cost, big.mark = ","), "\n")
  }
}
```

# 3. Economic Data (Online Sources)

```{r economic_parameters}
# Economic parameters - default values (will be updated from online sources)
economic_params <- list(
  # Utility rates
  current_electricity_rate = 0.12,  # $/kWh default
  rate_escalation_annual = 0.03,    # 3% annual increase
  
  # Solar economics
  solar_cost_per_watt = 4.15,       # $/W after tax credit
  solar_degradation_annual = 0.005, # 0.5% annual degradation
  federal_tax_credit = 0.30,        # 30% through 2025
  
  # Financial assumptions
  discount_rate = 0.04,             # 4% for NPV calculations
  analysis_period_years = 25,       # Standard solar analysis period
  
  # Home value
  home_value_current = 350000,      # Estimated current value
  solar_home_value_premium = 0.04   # 4% premium for solar homes
)

# Function to fetch current electricity rates (placeholder for online data)
fetch_electricity_rates <- function(utility = "Georgia_Power", zip = "30317") {
  # Placeholder - will implement API calls in separate chat
  cat("Online rate fetching not implemented yet.\n")
  cat("Using default rate:", economic_params$current_electricity_rate, "$/kWh\n")
  return(economic_params$current_electricity_rate)
}

# Update rates (placeholder)
current_rate <- fetch_electricity_rates()

cat("=== ECONOMIC ASSUMPTIONS ===\n")
cat("Current electricity rate: $", economic_params$current_electricity_rate, "/kWh\n")
cat("Federal tax credit:", economic_params$federal_tax_credit * 100, "%\n")
cat("Analysis period:", economic_params$analysis_period_years, "years\n")
```

# 4. Emissions Factors (Default with User Override)

```{r emissions_factors}
# Emissions factors - user configurable
emissions_params <- list(
  # Grid electricity emissions (lbs CO2/kWh)
  grid_emissions_factor = 0.99,     # GA Power comprehensive factor
  grid_emissions_decline_rate = 0.02, # 2% annual improvement
  
  # Natural gas emissions (lbs CO2/therm)
  gas_combustion_factor = 11.7,     # Direct combustion
  gas_fugitive_multiplier = 1.25,   # 25% additional from methane leaks
  gas_total_factor = 11.7 * 1.25,   # Total factor
  
  # Solar emissions (manufacturing/installation)
  solar_lifecycle_emissions = 0.04, # lbs CO2/kWh over lifetime
  
  # Appliance-specific factors
  water_heater_gas_therms_annual = 200,  # Typical gas water heater
  hvac_gas_therms_annual = 600,          # Heating portion
  
  # Social cost of carbon ($/ton CO2)
  social_cost_carbon = 51  # EPA 2024 estimate
)

# Function to calculate emissions scenarios
calculate_emissions_scenarios <- function(kwh_consumption, params) {
  
  # Convert lbs to tons (2000 lbs = 1 ton)
  lbs_to_tons <- function(lbs) lbs / 2000
  
  scenarios <- list()
  
  # Current emissions
  grid_emissions_lbs <- kwh_consumption * params$grid_emissions_factor
  gas_water_emissions_lbs <- params$water_heater_gas_therms_annual * params$gas_total_factor
  gas_heating_emissions_lbs <- params$hvac_gas_therms_annual * params$gas_total_factor
  
  total_emissions_tons <- lbs_to_tons(grid_emissions_lbs + gas_water_emissions_lbs + gas_heating_emissions_lbs)
  
  scenarios$current <- list(
    name = "Current Emissions",
    grid_emissions_tons = lbs_to_tons(grid_emissions_lbs),
    gas_emissions_tons = lbs_to_tons(gas_water_emissions_lbs + gas_heating_emissions_lbs),
    total_emissions_tons = total_emissions_tons,
    social_cost_annual = total_emissions_tons * params$social_cost_carbon
  )
  
  return(scenarios)
}

# Calculate current emissions
emissions_scenarios <- calculate_emissions_scenarios(
  house_params$annual_kwh_baseline,
  emissions_params
)

cat("=== EMISSIONS ANALYSIS ===\n")
cat("Current annual emissions:", round(emissions_scenarios$current$total_emissions_tons, 2), "tons CO2\n")
cat("Social cost of current emissions: $", round(emissions_scenarios$current$social_cost_annual, 0), "/year\n")

# Display user-configurable emissions factors
emissions_table <- data.frame(
  Parameter = c("Grid Emissions Factor", "Natural Gas Factor", "Social Cost of Carbon"),
  Current_Value = c(
    paste(emissions_params$grid_emissions_factor, "lbs CO2/kWh"),
    paste(round(emissions_params$gas_total_factor, 1), "lbs CO2/therm"),
    paste("$", emissions_params$social_cost_carbon, "/ton CO2")
  ),
  Description = c(
    "Including fugitive emissions",
    "Including methane leaks (25% adder)", 
    "EPA 2024 social cost estimate"
  )
)

kable(emissions_table, caption = "User-Configurable Emissions Factors") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# 5. Preliminary Graphing

```{r preliminary_graphs}
# Create summary visualization of current status vs. potential improvements

# Prepare data for visualization
consumption_comparison <- data.frame(
  Scenario = c("Current", "With Efficiency Upgrades", "Potential with Solar"),
  Annual_kWh = c(
    house_params$annual_kwh_baseline,
    efficiency_scenarios$all_efficiency$annual_kwh,
    0  # Will calculate solar offset
  ),
  Annual_Cost = c(
    house_params$annual_kwh_baseline * economic_params$current_electricity_rate,
    efficiency_scenarios$all_efficiency$annual_kwh * economic_params$current_electricity_rate,
    NA  # TBD with solar analysis
  ),
  CO2_Tons = c(
    emissions_scenarios$current$total_emissions_tons,
    emissions_scenarios$current$total_emissions_tons * 0.85,  # Estimated 15% reduction
    NA  # TBD with solar analysis
  )
)

# Energy consumption comparison
p1 <- ggplot(consumption_comparison[1:2,], aes(x = Scenario, y = Annual_kWh)) +
  geom_col(fill = c("red", "orange")) +
  geom_text(aes(label = paste(Annual_kWh, "kWh")), vjust = -0.5) +
  labs(title = "Annual Energy Consumption Scenarios",
       y = "Annual kWh",
       subtitle = paste("Potential savings:", 
                       house_params$annual_kwh_baseline - efficiency_scenarios$all_efficiency$annual_kwh, "kWh")) +
  theme_minimal()

# Cost comparison
p2 <- ggplot(consumption_comparison[1:2,], aes(x = Scenario, y = Annual_Cost)) +
  geom_col(fill = c("red", "orange")) +
  geom_text(aes(label = paste("$", round(Annual_Cost, 0))), vjust = -0.5) +
  labs(title = "Annual Electricity Cost Scenarios",
       y = "Annual Cost ($)") +
  theme_minimal()

# Display plots
print(p1)
print(p2)

# Summary metrics table
summary_metrics <- data.frame(
  Metric = c(
    "Current Annual Consumption",
    "Efficiency Upgrade Potential", 
    "Total Upgrade Investment",
    "Current Annual Emissions",
    "200A Panel Upgrade Required"
  ),
  Value = c(
    paste(house_params$annual_kwh_baseline, "kWh"),
    paste(efficiency_scenarios$all_efficiency$annual_savings_kwh, "kWh savings"),
    paste("$", format(efficiency_scenarios$all_efficiency$cost, big.mark = ",")),
    paste(round(emissions_scenarios$current$total_emissions_tons, 2), "tons CO2"),
    ifelse(house_params$panel_upgrade_required, "YES (Required for Solar)", "No")
  )
)

kable(summary_metrics, caption = "Key Decision Metrics") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```

# 6. Sensitivity Analysis Framework

```{r sensitivity_setup}
# Set up sensitivity analysis parameters
sensitivity_params <- list(
  # Variables to test
  variables = c(
    "electricity_rate",
    "solar_cost_per_watt", 
    "move_out_timeline",
    "efficiency_savings",
    "emissions_factor"
  ),
  
  # Variation ranges (low, baseline, high)
  electricity_rate_range = c(0.09, 0.12, 0.18),
  solar_cost_range = c(3.50, 4.15, 5.00),
  timeline_range = c(3, 10, 20),  # years
  efficiency_range = c(0.10, 0.15, 0.25),  # % savings
  emissions_range = c(0.45, 0.99, 1.20)  # lbs CO2/kWh
)

# Function to run sensitivity analysis (framework)
run_sensitivity_analysis <- function(base_params, sensitivity_ranges) {
  
  cat("=== SENSITIVITY ANALYSIS FRAMEWORK ===\n")
  cat("Variables to analyze:\n")
  for(var in sensitivity_params$variables) {
    cat("  -", var, "\n")
  }
  
  cat("\nSensitivity ranges defined. Full analysis will calculate:\n")
  cat("  - ROI impact of each variable\n")
  cat("  - Break-even points\n") 
  cat("  - Risk/uncertainty bounds\n")
  cat("  - Optimal decision thresholds\n")
  
  # Placeholder for full sensitivity analysis
  # Will implement tornado diagrams, scenario matrices, etc.
  
  return("Sensitivity framework ready")
}

# Initialize sensitivity analysis
sensitivity_result <- run_sensitivity_analysis(economic_params, sensitivity_params)
```

# Next Steps and Script Usage

```{r next_steps}
cat("=== R SCRIPT FRAMEWORK COMPLETE ===\n\n")

cat("NEXT STEPS:\n")
cat("1. Replace sample energy data with your actual CSV file\n")
cat("2. Update house parameters as you complete improvements\n") 
cat("3. Implement online data fetching for current rates/costs\n")
cat("4. Add solar system sizing and production calculations\n")
cat("5. Build comprehensive financial modeling (NPV, ROI, payback)\n")
cat("6. Complete sensitivity analysis with visualizations\n")
cat("7. Add decision optimization algorithms\n\n")

cat("TO USE THIS SCRIPT:\n")
cat("1. Save your energy bill data as 'energy_data.csv' with columns: date, kwh, cost\n")
cat("2. Update the efficiency_upgrades table as you complete improvements\n")
cat("3. Modify economic_params and emissions_params as needed\n")
cat("4. Re-run the entire script to see updated analysis\n\n")

cat("KEY VARIABLES YOU CAN MODIFY:\n")
cat("- house_params: Update completion status of improvements\n")
cat("- efficiency_upgrades: Add/modify upgrade options and costs\n") 
cat("- economic_params: Update rates, solar costs, financial assumptions\n")
cat("- emissions_params: Adjust emissions factors and social costs\n")
cat("- sensitivity_params: Change variables and ranges for analysis\n")
```